<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Controller</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        button { padding: 15px 30px; font-size: 18px; margin: 10px; cursor: pointer; }
        .btn-connect { background-color: #007bff; color: white; border: none; border-radius: 5px; }
        .btn-send { background-color: #28a745; color: white; border: none; border-radius: 5px; }
        #status { margin-top: 20px; color: #555; }
        #controls { display: none; margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px; }
        #device-list { margin-bottom: 20px; }
        .saved-device-btn { display: block; width: 100%; max-width: 300px; margin: 5px auto; padding: 10px; background: #eee; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <h2>ESP32 Manager</h2>

    <div id="device-list"></div>

    <button id="scanBtn" class="btn-connect">Scan & Connect</button>
    
    <div id="status">Status: Ready</div>

    <div id="controls">
        <input type="text" id="cmdInput" placeholder="Command (e.g. LED_ON)" style="padding:10px; width:60%;">
        <button id="sendBtn" class="btn-send">Send</button>
        <br>
        <button onclick="window.location.reload()">Disconnect</button>
    </div>

    <script>
        // UUIDs MUST MATCH YOUR ESP32 CODE
        const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const RX_UUID      = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';

        const scanBtn = document.getElementById('scanBtn');
        const statusDiv = document.getElementById('status');
        const controlsDiv = document.getElementById('controls');
        const deviceListDiv = document.getElementById('device-list');
        let rxChar;

        // 1. CHECK BROWSER SUPPORT
        if (!navigator.bluetooth) {
            statusDiv.innerHTML = "<b style='color:red'>Error: Web Bluetooth is not supported in this browser.</b><br>Use Chrome (Android/PC) or Bluefy (iOS). Ensure you are using HTTPS.";
            scanBtn.disabled = true;
        }

        // 2. LOAD SAVED DEVICES (If supported)
        // We use a separate check here so the app doesn't crash if getDevices is missing
        if (navigator.bluetooth && navigator.bluetooth.getDevices) {
            navigator.bluetooth.getDevices().then(devices => {
                devices.forEach(device => {
                    const btn = document.createElement('button');
                    btn.className = "saved-device-btn";
                    btn.innerText = "Re-connect: " + (device.name || "Unknown");
                    btn.onclick = () => connectToDevice(device);
                    deviceListDiv.appendChild(btn);
                });
            });
        }

        // 3. SCAN NEW DEVICE
        scanBtn.onclick = async () => {
            try {
                statusDiv.innerText = "Scanning...";
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });
                connectToDevice(device);
            } catch (error) {
                statusDiv.innerText = "Scan cancelled or failed: " + error;
            }
        };

        // 4. CONNECT LOGIC
        async function connectToDevice(device) {
            try {
                statusDiv.innerText = "Connecting to " + device.name + "...";
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                rxChar = await service.getCharacteristic(RX_UUID);

                // Success UI
                statusDiv.innerText = "Connected!";
                scanBtn.style.display = 'none';
                deviceListDiv.style.display = 'none';
                controlsDiv.style.display = 'block';

            } catch (error) {
                statusDiv.innerText = "Connection Failed: " + error;
            }
        }

        // 5. SEND COMMAND
        document.getElementById('sendBtn').onclick = async () => {
            const val = document.getElementById('cmdInput').value;
            if (rxChar && val) {
                const encoder = new TextEncoder();
                await rxChar.writeValue(encoder.encode(val + "\n"));
                document.getElementById('cmdInput').value = "";
            }
        };
    </script>
</body>
</html>
